package org.hanseo.boongboong.domain.carpool.repository;

import org.hanseo.boongboong.domain.carpool.entity.Post;
import org.hanseo.boongboong.domain.carpool.type.PostRole;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.time.LocalDate;
import java.time.LocalTime;
import java.util.List;
/**
 * Ïπ¥Ì? Í≤åÏãúÍ∏Ä Î¶¨Ìè¨ÏßÄ?†Î¶¨.
 * - ?•ÏÜå ??Í∏∞Î∞ò ?òÏù¥ÏßÄ Í≤Ä?? ÎßàÏù¥?òÏù¥ÏßÄ??Î™©Î°ù/?§Í????ºÏ†ï Ï°∞Ìöå ?úÍ≥µ
 */
public interface PostRepo extends JpaRepository<Post, Long> {

    // ===== Í≤Ä??=====
    @Query("""
           select p
             from Post p
            where (:date is null or p.date = :date)
              and p.route.originKey like :keyLike
              and (:type is null or p.type = :type)
         order by p.date asc, p.time asc
           """)
    Page<Post> findAllByOriginKeyLike(@Param("keyLike") String keyLike,
                                      @Param("date") LocalDate date,
                                      @Param("type") PostRole type,
                                      Pageable pageable);

    @Query("""
           select p
             from Post p
            where (:date is null or p.date = :date)
              and p.route.destKey like :keyLike
              and (:type is null or p.type = :type)
         order by p.date asc, p.time asc
           """)
    Page<Post> findAllByDestKeyLike(@Param("keyLike") String keyLike,
                                    @Param("date") LocalDate date,
                                    @Param("type") PostRole type,
                                    Pageable pageable);

    @Query("""
           select p
             from Post p
            where (:date is null or p.date = :date)
              and (p.route.originKey like :keyLike or p.route.destKey like :keyLike)
              and (:type is null or p.type = :type)
         order by p.date asc, p.time asc
           """)
    Page<Post> findAllByPlaceKeyLike(@Param("keyLike") String keyLike,
                                     @Param("date") LocalDate date,
                                     @Param("type") PostRole type,
                                     Pageable pageable);

    // ===== MyPage??=====
    List<Post> findTop50ByUserIdOrderByCreatedAtDesc(Long userId); // ?¥Í? ?¨Î¶∞ ÏµúÏã† 50

    /** Í∞Ä??Í∞ÄÍπåÏö¥ '?§Í??? Ïπ¥Ì? ?ÑÎ≥¥?§ÏùÑ ?ïÎ†¨?¥ÏÑú Î™®Îëê Î∞òÌôò (?úÎπÑ?§Ïóê??Ï≤?1Í∞úÎßå ?†ÌÉù) */
    @Query("""
           select p
             from Post p
            where p.user.id = :userId
              and (p.date > :today or (p.date = :today and p.time >= :now))
         order by p.date asc, p.time asc
           """)
    List<Post> findNearestUpcomingByAuthor(@Param("userId") Long userId,
                                           @Param("today") LocalDate today,
                                           @Param("now") LocalTime now);

    /** '?§Í??? Ïπ¥Ì? ?ÑÏ≤¥ Î¶¨Ïä§??*/
    @Query("""
           select p
             from Post p
            where p.user.id = :userId
              and (p.date > :today or (p.date = :today and p.time >= :now))
         order by p.date asc, p.time asc
           """)
    List<Post> findAllUpcomingByAuthor(@Param("userId") Long userId,
                                                                               @Param("today") LocalDate today,
                                                                               @Param("now") LocalTime now);
                                       
                                           /** '?ÑÎ£å?? Ïπ¥Ì? ?ÑÏ≤¥ Î¶¨Ïä§??*/
                                           @Query("""
                                                  select p
                                                    from Post p
                                                   where p.user.id = :userId
                                                     and (p.date < :today or (p.date = :today and p.time < :now))
                                                order by p.date desc, p.time desc
                                                  """)
                                           List<Post> findAllCompletedByAuthor(@Param("userId") Long userId,
                                                                               @Param("today") LocalDate today,
                                                                               @Param("now") LocalTime now);
                                       }